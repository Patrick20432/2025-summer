# Project1:SM4 软件实现与优化项目

## 一.项目简介

本项目围绕中国商用密码算法SM4的**软件实现与性能优化**展开，目标是在Python环境下实现SM4的基础版本、T-Table优化版本、NumPy批量优化版本，以及基于NumPy的SM4-GCM模式加密。最终实现对SM4算法不同实现方式的性能对比，并提升软件执行效率。


## 二.项目功能

### 1. SM4基础实现

- **功能**：按照国密标准规范，用纯Python实现SM4的分组加密，包括轮函数、S盒替代、线性变换和轮密钥加法。

- **原理**：实现最直接的算法流程，所有运算均逐步执行，使用Python的基本数据类型和循环。

- **性能特点**：Python解释器层面执行循环和字节操作，缺乏硬件级或批量优化，执行效率较低，适合验证算法正确性。


### 2. T-Table优化实现

- **功能**：用预先计算好的查找表（T-tables）合并S盒和线性变换步骤，减少每轮运算时的计算量。
    
- **优化原理**：
    
    - SM4的轮函数包括一个非线性S盒替代和一个线性变换（多次移位与异或）。
        
    - T-Table方法将这两个步骤合并，提前计算所有可能的字节输入对应的S盒和线性变换结果，存入表中。
        
    - 加密时，每个字节直接查表获取结果，避免实时复杂计算。
        
- **为什么快**：
    
    - 查表操作是内存访问，通常比执行移位和位运算快很多。
        
    - 减少了大量的按位运算，尤其是在Python这种解释型语言里优势明显。
        
- **限制**：查表需要额外内存，且无法利用CPU指令集的SIMD并行优势。
    

### 3. NumPy批量加密实现

- **功能**：利用NumPy的向量化运算，一次性批量处理大量16字节数据块，实现加密操作。
    
- **优化原理**：
    
    - Python的循环和字节操作效率低，重复处理单个数据块开销大。
        
    - NumPy底层使用C语言实现的高效数组运算，能一次对大块数据执行并行的算术和位运算。
        
    - 通过将多组数据组织为二维数组，使用NumPy的广播和矢量运算代替循环，显著减少Python层的执行时间。
        
- **为什么快**：
    
    - 大幅降低Python解释器的循环调用次数，避免每次加密调用Python函数的额外开销。
        
    - 利用底层优化的C库加速算术运算，提升计算密集型任务的吞吐量。
        
- **适用场景**：数据量大，需批量加密时效果最显著，单个数据块加密时性能提升有限。
    


### 4. SM4-GCM模式实现

- **功能**：实现Galois/Counter Mode (GCM) 的认证加密，结合SM4的CTR模式加密和GHASH认证计算，确保数据机密性和完整性。
    
- **优化原理**：
    
    - **CTR模式**：将计数器块批量生成并一次性加密，利用NumPy批量加密优化，提高计数器流的生成速度。
        
    - **GHASH认证**：用NumPy实现对128位字段的乘法运算，尽量减少循环开销。
        
    - 整体实现利用向量化和批量处理，减少认证加密的Python调用次数。
        
- **为什么快**：
    
    - 批量生成和加密计数器块比逐块生成效率高。
        
    - GHASH利用向量化减少逐块乘法的解释器开销。
        
    - GCM模式中加密和认证紧密结合，优化批量计算显著提升整体性能。
        
- **重要性**：GCM是现代加密协议中广泛使用的认证加密模式，支持高性能安全通信。

## 三.项目结构


```
├── sm4_basic.py         # SM4基础实现
├── sm4_ttable.py        # T-Table优化实现
├── sm4_numpy.py         # NumPy批量加密实现
├── sm4_gcm.py           # SM4-GCM模式实现
├── utils.py             # 工具函数（字节序转换、异或等）
├── test_sm4_gcm.py      # 测试与性能对比脚本（含性能图生成）
└── README.md            # 项目说明文档（本文件）
```

## 四.使用说明

1. 克隆或下载项目到本地。
 
2. 确保Python环境安装了`numpy`和`matplotlib`：
```
pip install numpy matplotlib
```

3. 运行测试脚本进行性能对比：
```
 python test_sm4_gcm.py
 ```

## 五.性能数据示例

|实现方式|时间 (秒)|速度 (MB/s)|
|---|---|---|
|基础版|11.86|0.13|
|T-Table版|6.30|0.24|
|NumPy批量版|1.10|1.38|
|GCM模式|6.02|0.25|

从数据可以看出，**NumPy批量优化版本在处理大量数据时性能提升显著**，相比基础版本提升超过10倍，适合大规模数据加密场景。

## 六.设计与实现细节

- **SM4基础实现**  
    遵循国密标准，逐轮进行S盒替代、线性变换和轮密钥加法。
    
- **T-Table优化**  
    预计算变换表，减少重复计算，降低循环内计算复杂度。
    
- **NumPy批量加密**  
    利用NumPy的矢量运算能力批量处理数据块，减少Python解释器调用开销。
    
- **GCM模式**  
    实现CTR计数器模式的流式加密，并结合GHASH进行认证，确保数据完整性与机密性。